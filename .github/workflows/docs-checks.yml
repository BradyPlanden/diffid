name: Documentation Checks

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs-checks.yml'

permissions:
  contents: read

jobs:
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocstrings[python] \
                      mkdocs-git-revision-date-localized-plugin \
                      mkdocs-minify-plugin mkdocs-jupyter pymdown-extensions

      - name: Build documentation
        run: mkdocs build --strict

      - name: Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          # Check all markdown files
          args: --verbose --no-progress 'docs/**/*.md' 'site/**/*.html' --exclude-path 'site/tutorials/notebooks' --max-concurrency 10
          # Don't fail on broken links in draft mode
          fail: ${{ github.event_name != 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create Issue on Failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìã Documentation link check failed',
              body: 'Scheduled link check found broken links in documentation.\n\nSee workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              labels: ['documentation', 'automated']
            })

  test-docs:
    name: Documentation Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install chronopt and dependencies
        run: |
          uv pip install --system pytest
          uv pip install --system mkdocs mkdocs-material mkdocstrings[python] \
                          mkdocs-git-revision-date-localized-plugin \
                          mkdocs-minify-plugin mkdocs-jupyter pymdown-extensions
          # Install chronopt if possible (may fail if rust build needed)
          uv pip install --system -e python/ || echo "‚ö†Ô∏è  Could not install chronopt (rust build required)"

      - name: Run documentation tests
        run: pytest tests/test_docs.py -v
        continue-on-error: true  # Don't fail if chronopt not installed

  notebook-validation:
    name: Validate Notebooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jupyter nbformat nbconvert

      - name: Validate notebook format
        run: |
          for notebook in docs/tutorials/notebooks/*.ipynb; do
            echo "Validating $notebook"
            python -m nbformat.validator "$notebook" || echo "‚ö†Ô∏è  $notebook validation failed"
          done

      - name: Check for execution errors
        run: |
          # Check notebooks don't have error outputs
          for notebook in docs/tutorials/notebooks/*.ipynb; do
            if grep -q '"output_type": "error"' "$notebook"; then
              echo "‚ùå $notebook contains error outputs"
              exit 1
            fi
          done
          echo "‚úÖ No error outputs found in notebooks"

  spelling-check:
    name: Spelling Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check British English spelling
        uses: reviewdog/action-misspell@v1
        with:
          github_token: ${{ secrets.github_token }}
          locale: "UK"
          reporter: github-pr-review
          level: warning
          filter_mode: diff_context
          # Exclude code blocks and technical terms
          exclude: |
            *.ipynb
            *.py
            *.rs

  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocstrings[python] \
                      mkdocs-git-revision-date-localized-plugin \
                      mkdocs-minify-plugin mkdocs-jupyter pymdown-extensions

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-preview-pr-${{ github.event.pull_request.number }}
          path: site/
          retention-days: 7

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üìö Documentation Preview

            Documentation built successfully for this PR!

            **Download Preview**: Check the artifacts section of [this workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Build Details**:
            - Commit: \`${{ github.sha }}\`
            - Built at: ${new Date().toISOString()}

            To view locally:
            1. Download the \`docs-preview-pr-${{ github.event.pull_request.number }}\` artifact
            2. Extract and open \`index.html\` in a browser

            _This preview will be available for 7 days._
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            })
